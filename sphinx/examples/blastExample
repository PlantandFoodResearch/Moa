#!/usr/bin/env bash

## Mark: The input data for this script needs to be modified to conform to your original example
## which included a bash post command doing 'grep dicer ...'

mkdir test.project && cd test.project
mkdir 00.blastdb && cd 00.blastdb

## copy or create symbolic links to protein sequences in 00.proteins
cat - > ex.fasta << 'EOF'
>gi|6850311|gb|AAF29388.1|AC009999_8 Contains similarity to a vacuolar sorting receptor homolog from Arabidopsis thaliana gb|U79959 [Arabidopsis thaliana]
MSLPPFTCRLLAAAAALYLIGLLCVGADTKDVTAPKIPGCSNEFQMVKVENWVNGENGETFTAMTAQFGT
MLPSDKDKAVKLPVALTTPLDSCSNLTSKLSWSIALSVRGECAFTVKAQVAQAGGAAALVLINDKEELDE
MVCGEKDTSLNVSIPILMITTSSGDALKKSIMQNKKVELLLYAPKSPIVDDSCSNLSVGTVFVASVW
SHVTSPKKNDEQYDELSPKKSSNVDATKGGAEEETLDISAMGAVIFVISASTFLVLLFFFMSSWFILILT
IFFVIGGMQGMHNINVTLITRRCSKCGQKNLKLPLLGNTSILSLVVLLFCFVVAILWFMNRKTSHAWAGQ
DIFGICMMINVLQVARLPNIRVATILLCCAFFYDIFWVFISPLIFKQSVMIAVARGSKDTGESIPMLLRI
PRLSDPWGGYNMIGFGDILFPGLLICFIFRFDKENNKGVSNGYFPWLMFGYGLGLFLTYLGLYVMNGHGQ
PALLYLVPCTLGITVILGLVRKELRDLWNYGTQQPSAADVNPSPEA

>gi|4850398|gb|AAD31068.1|AC007357_17 Strong similarity to gi|3313615 F21J9.9 from Arabidopsis thaliana and is a member of the PF|00067 Cytochrome P450 family [Arabidopsis thaliana]
MSEISSSMPLTERVYNHLCLSDVSLALLGLFVFCCVREKVTKKLGPTIWPVFGITPEFFFHRNDVYGWAT
RCLKKCRGTFLYNGIWLGGSYGAVTCVPANVEYMLKTNFKNFPKGAFFKERFNDLLEDGIFNADAESWKE
QRRIIITEMHSTRFVEHSFQTTQDLVRKKLLKVMESFARSQEAFDLQDVLLRLTFDNICIAGLGDDPGTL
DSDLPLVPFAQAFEEATESTMFRFMIPPFIWKPLKFFDIGYEKGLRKAVDVSMSLSTRWLWIVSASSKKK
EQSHKTTDEKDPSTIKFFRQFCTSFILAGRDTSSVALTWFFWVIQKHPEVENKIIREISEILRQRGDSPT
SKNESLFTVKELNDMVYLQAALSETMRLYPPIPMEMKQAIEDDVFPDGTFIRKGSRVYFATYAMGRMESI
WGKDCESFKPERWIQSGNFVNDDQFKYVVFNAGPRLCLGKTFAYLQMKTIAASVLSRYSIKVAKDHVVVP
RVTTTLYMRHGLKVTISSKSLEEKIHVQD

>gi|4850394|gb|AAD31064.1|AC007357_13 Identical to gb|X97864 cytochrome P450 from Arabidopsis thaliana and is a member of the PF|00067 Cytochrome P450 family. ESTs gb|T44875, gb|T04814, gb|R65111, gb|T44310 and gb|T04541 come from this gene [Arabidopsis thaliana]
MSILLCFLCLLPVFLVSLSILSKRLKPSKWKLPPGPKTLPIIGNLHNLTGLPHTCFRNLSQKFGPVMLLH
FGFVPVVVISSKEGAEEALKTQDLECCSRPETVATRMISYNFKDIGFAPYGEEWKALRKLVVMELLNTKK
FQSFRYIREEENDLLIKKLTESALKKSPVNLKKTLFTLVASIVCRLAFGVNIHKCEFVDEDNVADLVNKF
EMLVAGVAFTDFFPGVGWLVDRISGQNKTLNNVFSELDTFFQNVLDDHIKPGRQVSENPDVVDVMLDLMK
KQEKDGESFKLTTDHLKGIISDIFLAGVNTSAVTLNWAMAELIRNPRVMKKVQDEIRTTLGDKKQRITEQ
DLSQVHYFKLVVKEIFRLHPAAPLLLPRETMSHVKIQGYDIPVKTQMMINIYSIARDPKLWTNPDEFNPD
RFLDSSIDYRGLNFELLPFGSGRRICPGMTLGITTVELGLLNLLYFFDWVVPVGKNVKDINLEETGSIII
SKKTTLELVPLVHH
EOF

## Create blast db 
formatdb -i ex.fasta -p T 

mkdir ../10.fasta && cd ../10.fasta

## Generate query files
cat - > query1.fasta << 'EOF'
>query1
LLAAAAALYLIGLLCVGADKDVTAPKIPGCSNEFQMVKVEWVNGENGETFTAMTAQFGT
MLPSDKDKAVKLPVALTTLDSCSNLTSKLSWSIALSVRGECAFTVKAQVAQAGG
EOF

cat - > query2.fasta << 'EOF'
>query2
KCRGTFLYNGIWLGGSYGAVTCVPANVEYMLTSSVALTWFFWVQKHPPVEVENKIIREISEILRQRGDS
EOF

## Using formatdb from older blast version
## makeblastdb -in refseq_protein â€“input_type blastdb -dbtype prot

mkdir ../20.blast && cd ../20.blast

## Create new moa blast template
moa new blast -t "demo run"

## Define blast database location
moa set db=../00.blastdb/ex.fasta

## Define input sequence(s) location
moa set input=../10.fasta/*.fasta

## Define blast application to use
moa set program=blastp


## List template variables
moa show

## Execute the moa job 
moa run

## Manually check output descriptions for the pattern 'dicer'
grep -i dicer blast_report

## Set a moa post command (Check: can this be configured without STDIN intervention?)
## moa set postcommand
## > grep -i dicer blast_report > dicer.out
